{-# LANGUAGE OverloadedStrings #-}

module WebHookSpec (spec) where

import Data.Aeson (eitherDecode, encode)
import Data.ByteString.Lazy (ByteString)
import Test.Hspec (Spec, describe, it, shouldBe)
import WebHook (Commit (Commit), Repo (Repo))

spec :: Spec
spec = describe "WebHook" $ do
    it "parse minimum json" $
        eitherDecode commitJson `shouldBe` Right commit
    it "encode correctly" $
        encode commit `shouldBe` commitJson
    it "parse real json" $
        eitherDecode githubJson `shouldBe` Right commit

commit :: Commit
commit =
    Commit
        "9c43cbabed7769d9fa28aebca99db9457b9f7c7e"
        $ Repo
            "https://github.com/TerenceNg03/CI-Server.git"
            "https://api.github.com/repos/TerenceNg03/CI-Server/statuses/{sha}"

commitJson :: ByteString
commitJson = "{\"after\":\"9c43cbabed7769d9fa28aebca99db9457b9f7c7e\",\"repository\":{\"clone_url\":\"https://github.com/TerenceNg03/CI-Server.git\",\"statuses_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/statuses/{sha}\"}}"

githubJson :: ByteString
githubJson = "{\"ref\":\"refs/heads/feature/#16-handle-webhook-payload\",\"before\":\"0000000000000000000000000000000000000000\",\"after\":\"9c43cbabed7769d9fa28aebca99db9457b9f7c7e\",\"repository\":{\"id\":752050777,\"node_id\":\"R_kgDOLNNiWQ\",\"name\":\"CI-Server\",\"full_name\":\"TerenceNg03/CI-Server\",\"private\":false,\"owner\":{\"name\":\"TerenceNg03\",\"email\":\"terenceng03@outlook.com\",\"login\":\"TerenceNg03\",\"id\":63455223,\"node_id\":\"MDQ6VXNlcjYzNDU1MjIz\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/63455223?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/TerenceNg03\",\"html_url\":\"https://github.com/TerenceNg03\",\"followers_url\":\"https://api.github.com/users/TerenceNg03/followers\",\"following_url\":\"https://api.github.com/users/TerenceNg03/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/TerenceNg03/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/TerenceNg03/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/TerenceNg03/subscriptions\",\"organizations_url\":\"https://api.github.com/users/TerenceNg03/orgs\",\"repos_url\":\"https://api.github.com/users/TerenceNg03/repos\",\"events_url\":\"https://api.github.com/users/TerenceNg03/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/TerenceNg03/received_events\",\"type\":\"User\",\"site_admin\":false},\"html_url\":\"https://github.com/TerenceNg03/CI-Server\",\"description\":\"Coursework for DD2480 Assignment #2\",\"fork\":false,\"url\":\"https://github.com/TerenceNg03/CI-Server\",\"forks_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/forks\",\"keys_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/keys{/key_id}\",\"collaborators_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/collaborators{/collaborator}\",\"teams_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/teams\",\"hooks_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/hooks\",\"issue_events_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/issues/events{/number}\",\"events_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/events\",\"assignees_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/assignees{/user}\",\"branches_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/branches{/branch}\",\"tags_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/tags\",\"blobs_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/git/blobs{/sha}\",\"git_tags_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/git/tags{/sha}\",\"git_refs_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/git/refs{/sha}\",\"trees_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/git/trees{/sha}\",\"statuses_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/statuses/{sha}\",\"languages_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/languages\",\"stargazers_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/stargazers\",\"contributors_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/contributors\",\"subscribers_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/subscribers\",\"subscription_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/subscription\",\"commits_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/commits{/sha}\",\"git_commits_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/git/commits{/sha}\",\"comments_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/comments{/number}\",\"issue_comment_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/issues/comments{/number}\",\"contents_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/contents/{+path}\",\"compare_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/compare/{base}...{head}\",\"merges_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/merges\",\"archive_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/{archive_format}{/ref}\",\"downloads_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/downloads\",\"issues_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/issues{/number}\",\"pulls_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/pulls{/number}\",\"milestones_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/milestones{/number}\",\"notifications_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/notifications{?since,all,participating}\",\"labels_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/labels{/name}\",\"releases_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/releases{/id}\",\"deployments_url\":\"https://api.github.com/repos/TerenceNg03/CI-Server/deployments\",\"created_at\":1706913811,\"updated_at\":\"2024-02-07T09:38:53Z\",\"pushed_at\":1707443799,\"git_url\":\"git://github.com/TerenceNg03/CI-Server.git\",\"ssh_url\":\"git@github.com:TerenceNg03/CI-Server.git\",\"clone_url\":\"https://github.com/TerenceNg03/CI-Server.git\",\"svn_url\":\"https://github.com/TerenceNg03/CI-Server\",\"homepage\":\"https://terenceng03.github.io/CI-Server/\",\"size\":423,\"stargazers_count\":1,\"watchers_count\":1,\"language\":\"Haskell\",\"has_issues\":true,\"has_projects\":true,\"has_downloads\":true,\"has_wiki\":false,\"has_pages\":true,\"has_discussions\":false,\"forks_count\":0,\"mirror_url\":null,\"archived\":false,\"disabled\":false,\"open_issues_count\":11,\"license\":null,\"allow_forking\":true,\"is_template\":false,\"web_commit_signoff_required\":false,\"topics\":[],\"visibility\":\"public\",\"forks\":0,\"open_issues\":11,\"watchers\":1,\"default_branch\":\"master\",\"stargazers\":1,\"master_branch\":\"master\"},\"pusher\":{\"name\":\"TerenceNg03\",\"email\":\"terenceng03@outlook.com\"},\"sender\":{\"login\":\"TerenceNg03\",\"id\":63455223,\"node_id\":\"MDQ6VXNlcjYzNDU1MjIz\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/63455223?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/TerenceNg03\",\"html_url\":\"https://github.com/TerenceNg03\",\"followers_url\":\"https://api.github.com/users/TerenceNg03/followers\",\"following_url\":\"https://api.github.com/users/TerenceNg03/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/TerenceNg03/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/TerenceNg03/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/TerenceNg03/subscriptions\",\"organizations_url\":\"https://api.github.com/users/TerenceNg03/orgs\",\"repos_url\":\"https://api.github.com/users/TerenceNg03/repos\",\"events_url\":\"https://api.github.com/users/TerenceNg03/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/TerenceNg03/received_events\",\"type\":\"User\",\"site_admin\":false},\"created\":true,\"deleted\":false,\"forced\":false,\"base_ref\":null,\"compare\":\"https://github.com/TerenceNg03/CI-Server/commit/9c43cbabed77\",\"commits\":[{\"id\":\"9c43cbabed7769d9fa28aebca99db9457b9f7c7e\",\"tree_id\":\"2eec5998f34b161dbd72d3b35ba4257afd6e8d18\",\"distinct\":true,\"message\":\"Add signature verfication\",\"timestamp\":\"2024-02-09T02:56:35+01:00\",\"url\":\"https://github.com/TerenceNg03/CI-Server/commit/9c43cbabed7769d9fa28aebca99db9457b9f7c7e\",\"author\":{\"name\":\"TerenceNg03\",\"email\":\"terenceng03@outlook.com\",\"username\":\"TerenceNg03\"},\"committer\":{\"name\":\"TerenceNg03\",\"email\":\"terenceng03@outlook.com\",\"username\":\"TerenceNg03\"},\"added\":[\"server/config-example.yaml\"],\"removed\":[\"server/config.yaml\"],\"modified\":[\"server/.gitignore\",\"server/package.yaml\",\"server/server.cabal\",\"server/src/Server.hs\"]}],\"head_commit\":{\"id\":\"9c43cbabed7769d9fa28aebca99db9457b9f7c7e\",\"tree_id\":\"2eec5998f34b161dbd72d3b35ba4257afd6e8d18\",\"distinct\":true,\"message\":\"Add signature verfication\",\"timestamp\":\"2024-02-09T02:56:35+01:00\",\"url\":\"https://github.com/TerenceNg03/CI-Server/commit/9c43cbabed7769d9fa28aebca99db9457b9f7c7e\",\"author\":{\"name\":\"TerenceNg03\",\"email\":\"terenceng03@outlook.com\",\"username\":\"TerenceNg03\"},\"committer\":{\"name\":\"TerenceNg03\",\"email\":\"terenceng03@outlook.com\",\"username\":\"TerenceNg03\"},\"added\":[\"server/config-example.yaml\"],\"removed\":[\"server/config.yaml\"],\"modified\":[\"server/.gitignore\",\"server/package.yaml\",\"server/server.cabal\",\"server/src/Server.hs\"]}}"
